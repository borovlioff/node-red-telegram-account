<script type="text/javascript">
    RED.nodes.registerType('auth', {
        category: 'telegram-account',
        color: '#a6bbcf',
        defaults: {
            api_id: { value: "" },
            api_hash: { value: "" },
            phoneNumber: { value: "" },
            password: { value: "" },
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-lock",
        label: function () {
            return this.name || "Telegram Auth";
        },
        oneditprepare: function () {
            // Инициализация значений
            $("#node-input-api_id").val(this.api_id || "");
            $("#node-input-api_hash").val(this.api_hash || "");
            $("#node-input-phoneNumber").val(this.phoneNumber || "");
            $("#node-input-password").val(this.password || "");
        },
        oneditsave: function () {
            // Сохранение значений
            this.api_id = $("#node-input-api_id").val();
            this.api_hash = $("#node-input-api_hash").val();
            this.phoneNumber = $("#node-input-phoneNumber").val();
            this.password = $("#node-input-password").val();
        },
    });
</script>

<script type="text/html" data-template-name="auth">
<div class="form-row">
    <label for="node-input-api_id">
        <i class="fa fa-key"></i> API ID
    </label>
    <input type="text" id="node-input-api_id" placeholder="Enter your API ID">
</div>

<div class="form-row">
    <label for="node-input-api_hash">
        <i class="fa fa-lock"></i> API Hash
    </label>
    <input type="text" id="node-input-api_hash" placeholder="Enter your API Hash">
</div>

<div class="form-row">
    <label for="node-input-phoneNumber">
        <i class="fa fa-phone"></i> Phone Number
    </label>
    <input type="text" id="node-input-phoneNumber" placeholder="Enter your phone number">
</div>

<div class="form-row">
    <label for="node-input-password">
        <i class="fa fa-unlock-alt"></i> Password (optional)
    </label>
    <input type="password" id="node-input-password" placeholder="Enter your password (if any)">
</div>

<p>
    <strong>Note:</strong> This configuration is required for connecting to the Telegram API and starting a session.
</p>
</script>


<script type="text/html" data-help-name="auth">
  <p>The <b>auth</b> node allows Telegram API authentication using the <code>telegram</code> library. It handles two-factor authentication if required and provides a <code>stringSession</code> for later use.</p>

  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>payload.api_id <span class="property-type">number | string</span></dt>
    <dd>Telegram API ID. Required for authentication.</dd>

    <dt>payload.api_hash <span class="property-type">string</span></dt>
    <dd>Telegram API hash. Required for authentication.</dd>

    <dt>payload.phoneNumber <span class="property-type">string</span></dt>
    <dd>Phone number associated with the Telegram account. Required.</dd>

    <dt>payload.password <span class="property-type">string</span></dt>
    <dd>Password for two-factor authentication (if enabled). Optional.</dd>
  </dl>

  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>topic <span class="property-type">string</span></dt>
    <dd>
      <b>"need_code"</b>: Node requests a Telegram code from the user.<br>
      <b>"auth_success"</b>: Authentication completed successfully; session is ready.<br>
      <b>"auth_error"</b>: An error occurred during authentication.
    </dd>

    <dt>payload <span class="property-type">object</span></dt>
    <dd>
      For <b>"auth_success"</b>:
      <ul>
        <li><code>payload.stringSession</code>: Generated session string.</li>
        <li><code>payload.phoneNumber</code>: Phone number used.</li>
        <li><code>payload.client</code>: Instance of TelegramClient (for internal flows).</li>
        <li><code>payload.message</code>: Success message.</li>
      </ul>
      For <b>"auth_error"</b>:
      <ul>
        <li><code>payload.error</code>: Error message describing the issue.</li>
      </ul>
      For <b>"need_code"</b>:
      <ul>
        <li><code>payload.phoneNumber</code>: Phone number that requires code input.</li>
      </ul>
    </dd>
  </dl>

  <h3>Details</h3>
  <p>Provide the required API credentials and phone number in the input message payload. The node will start the Telegram authentication flow. If two-factor authentication is required, provide <code>payload.password</code> (optional).</p>
  <p>When a code is required, the node sends a message with <code>topic = "need_code"</code>. The phone code resolver is temporarily stored in the flow context under the key <code>phoneCode_<i>phoneNumber</i></code>. This allows another node or interface to provide the code and resolve the authentication promise.</p>

  <h3>Example</h3>
  <pre>
{
  "payload": {
    "api_id": 123456,
    "api_hash": "your_api_hash",
    "phoneNumber": "+123456789",
    "password": "your_password"
  }
}
  </pre>
  <p>After the phone code is sent by Telegram, it must be resolved using a separate input (for example, via a form or HTTP request) to complete the authentication.</p>
</script>